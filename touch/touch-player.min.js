(()=>{return(t,e)=>{const i=(t,e)=>{return t.data("events")[e][0].handler};const o=t=>{let e=0;let i=0;while(t&&!isNaN(t.offsetLeft)&&!isNaN(t.offsetTop)){e+=t.offsetLeft-t.scrollLeft;i+=t.offsetTop-t.scrollTop;t=t.offsetParent}return{x:e,y:i}};const s=(t,e=1)=>{const i=t.toString();const o=i.indexOf(".");if(o!==-1){if(i.length-o>e+1){return i.substring(0,o+e+1)}else{return i}}else{return i+".0"}};const n=t=>{t=Math.abs(t);const e=Math.floor(t/3600);const i=Math.floor((t-e*3600)/60);const o=t-e*3600-i*60;let n=s(o)+"秒";if(i>0){n=i+"分"+n}if(e>0){n=e+"时"+n}return n};const l=t=>{t=Math.abs(t);const e=Math.floor(t/3600);const i=Math.floor((t-e*3600)/60);const o=t-e*3600-i*60;let n=(o<10?"0":"")+s(o);n=(i<10?"0":"")+i+":"+n;n=(e<10?"0":"")+e+":"+n;return n};console.log("define swiper");class a{constructor(t){console.log("create swiper:");console.log(t);this.action=new c(t);this.onTouchStart=null;this.onTouchEnd=null;this._direction=null;t.addEventListener("touchstart",t=>{this._xDown=t.touches[0].clientX;this._yDown=t.touches[0].clientY;if(this.onTouchStart){this.onTouchStart(t)}});t.addEventListener("touchmove",e=>{if(!this._xDown||!this._yDown){return}const i=e.touches[0].clientX;const s=e.touches[0].clientY;const n=o(t);const l={x:(e.touches[0].pageX-n.x)/t.clientWidth,y:(e.touches[0].pageY-n.y)/t.clientHeight,width:t.clientWidth,height:t.clientHeight};const a=this._xDown-i;const c=this._yDown-s;if(!this._direction){let t="";if(Math.abs(a)>Math.abs(c)){t="horizontal"}else{t="vertical"}this._direction=t;e.preventDefault()}else{if(this._direction==="vertical"){this.action.startAction(this._direction,c,l)}else if(this._direction==="horizontal"){this.action.startAction(this._direction,-a,l)}e.preventDefault()}});t.addEventListener("touchend",t=>{this._xDown=null;this._yDown=null;this._direction=null;if(this.onTouchEnd){this.onTouchEnd(t)}});console.log("events attached.")}}class c{constructor(t){this.lowSpeedForward=null;this.lowSpeedBackward=null;this.mediumSpeedForward=null;this.mediumSpeedBackward=null;this.highSpeedForward=null;this.highSpeedBackward=null;this.lowVolumeUp=null;this.lowVolumeDown=null;this.mediumVolumeUp=null;this.mediumVolumeDown=null;this.highVolumeUp=null;this.highVolumeDown=null;this.speedCancel=null;this.volumeCancel=null;this.minSwipeDistance=20;this.onActionStart=null;this.onActionEnd=null;this._element=t;this._touchStart=false;this._startPosition=null;this._lastAction=null;t.addEventListener("touchstart",t=>{this._touchStart=true});t.addEventListener("touchend",t=>{this._startPosition=null;this.onActionEnd&&this.onActionEnd(this._lastAction);this._lastAction=null})}startAction(t,e,i){if(this._touchStart){this.onActionStart&&this.onActionStart();this._startPosition=i;this._touchStart=false}if(t==="vertical"){if(Math.abs(e)<this.minSwipeDistance){this.volumeCancel&&this.volumeCancel();this._lastAction=null}else{let t=0;let o=undefined;let s=undefined;if(this._startPosition.x<1/3){t=.4;o=this.lowVolumeUp;s=this.lowVolumeDown}else if(this._startPosition.x>=1/3&&this._startPosition.x<=2/3){t=1;o=this.mediumVolumeUp;s=this.mediumVolumeDown}else{t=2;o=this.highVolumeUp;s=this.highVolumeDown}if(e>0){const s=Math.round(t*100*(e-this.minSwipeDistance)/(1.5*i.height));o&&o(s);this._lastAction={type:"volume",volume:s}}else{const o=Math.round(t*100*(e+this.minSwipeDistance)/(1.5*i.height));s&&s(o);this._lastAction={type:"volume",volume:o}}}}else if(t==="horizontal"){if(i.y<1/3&&(i.x<.1||i.x>.9)||Math.abs(e)<this.minSwipeDistance){this.speedCancel&&this.speedCancel();this._lastAction=null}else{let t=0;let i=undefined;let o=undefined;if(this._startPosition.y<1/3){t=.05;i=this.lowSpeedForward;o=this.lowSpeedBackward}else if(this._startPosition.y>=1/3&&this._startPosition.y<=2/3){t=.2;i=this.mediumSpeedForward;o=this.mediumSpeedBackward}else{t=1;i=this.highSpeedForward;o=this.highSpeedBackward}if(e>0){const o=(e-this.minSwipeDistance)*t;i&&i(o);this._lastAction={type:"playback",seconds:o}}else{const i=(e+this.minSwipeDistance)*t;o&&o(i);this._lastAction={type:"playback",seconds:i}}}}}}class r{constructor(){const t=window.location.href;const e=t.match(/av([\d]+)/);this.aid=e[1];const i=t.match(/p=([\d]+)/);this.page=i?i[1]:1;this.pagesData=null;this.cidMap={};this.cidData={};this.supportWebp=r.supportWebp;downloadText(t,t=>this.findCid(t))}findCid(t){const e=t.match(/"pages":(\[[^\0]*\]),"embedPlayer"/);if(e){this.pagesData=JSON.parse(e[1]);this.pagesData.forEach(t=>{this.cidMap[t.page]=t.cid})}}getVideoshot(t,e){if(!this.cidData[this.page]){downloadText(`https://api.bilibili.com/x/player/videoshot?aid=${this.aid}&cid=${this.cidMap[this.page]}&index=1`,i=>{this.cidData[this.page]=JSON.parse(i).data;this.getVideoshot(t,e)})}else{const i=this.cidData[this.page];const o=i.index;let s=0;for(let e=0;e<o.length-2;e++){if(t>=o[e]&&t<o[e+1]){s=e;break}}let n=i.image;if(this.supportWebp){n=n.map(t=>t.replace(".jpg",".jpg@.webp"))}const l=parseInt(i.pv_x_len)||10;const a=parseInt(i.pv_y_len)||10;const c=parseInt(i.pv_x_size)||160;const r=parseInt(i.pv_y_size)||90;const d=-(s%100%l)*c;const h=-Math.floor(s%100/a)*r;e({width:c,height:r,backgroundImage:`url(${n[Math.floor(s/100)]})`,backgroundPosition:`${d}px ${h}px`})}}static get supportWebp(){try{const t=document.createElement("canvas");if(t.getContext&&t.getContext("2d"))try{return t.toDataURL("image/webp").indexOf("data:image/webp")===0}catch(t){return false}else return false}catch(t){return false}}}SpinQuery.any(()=>$(".bilibili-player-video-web-fullscreen"),t=>{if(!t.hasClass("bilibili-player-video-btn")&&$(".bilibili-player-video-btn-fullscreen").data("events")){const e=i($(".bilibili-player-video-btn-fullscreen"),"click");t.detach().insertAfter(".bilibili-player-video-btn-widescreen").addClass("bilibili-player-video-btn").on("click",e)}});SpinQuery.any(()=>$(".bilibili-player-iconfont,.bilibili-player-video-quality-menu"),t=>t.unbind("click"));new SpinQuery(()=>$(".bilibili-player-video"),t=>t.length>0&&$("video").length>0,t=>{console.log("found player box:");console.log(t);if($(".touch-video-box").length===0){$(".bilibili-player-video-subtitle").before(`<div class='touch-video-box-wrapper'>\n                            <div class='touch-video-box'>\n                                <div class='touch-video-info'></div>\n                                <div class='touch-progress'></div>\n                            </div>\n                        </div>`);const e=$("video");e.on("loadedmetadata",()=>{console.log("video metadata loaded.");const i=e.prop("duration");const o=new a(t.get(0));const c=document.getElementsByClassName("touch-video-info")[0];const d=document.getElementsByClassName("touch-video-box")[0];let h=Math.round(e.prop("volume")*100);const u=t=>{t/=100;if(t<0){t=0}else if(t>1){t=1}e.prop("volume",t);$(".bilibili-player-video-volume-num").text(Math.round(t*100));$(".bui-thumb").css("transform",`translateY(-${48*t}px)`);$(".bui-track-vertical .bui-bar").css("transform",`scaleY(${t})`);if(t===0){$(".bilibili-player-video-btn-volume").addClass(".video-state-volume-min");$(".bilibili-player-video-btn-volume").removeClass(".video-state-volume-max");e.prop("muted",true)}else if(t===1){$(".bilibili-player-video-btn-volume").removeClass(".video-state-volume-min");$(".bilibili-player-video-btn-volume").addClass(".video-state-volume-max");e.prop("muted",false)}else{$(".bilibili-player-video-btn-volume").removeClass(".video-state-volume-min");$(".bilibili-player-video-btn-volume").removeClass(".video-state-volume-max");e.prop("muted",false)}$(".bpui-slider-progress").css("height",t*100+"%");$(".bpui-slider-handle").css("bottom",(35+t*230)/3+"%");if(t===0){$(".icon-24soundoff").show();$(".icon-24soundlarge").hide();$(".icon-24soundsmall").hide()}else if(t>=.5){$(".icon-24soundoff").hide();$(".icon-24soundlarge").show();$(".icon-24soundsmall").hide()}else{$(".icon-24soundoff").hide();$(".icon-24soundlarge").hide();$(".icon-24soundsmall").show()}};o.action.onActionStart=(()=>{d.style.display="flex";c.innerHTML="";h=Math.round(e.prop("volume")*100)});const p=new r;const m=t=>{return o=>{const a=e.prop("currentTime");let r=a+o;let d=s(100*r/i);let h=o;if(r>i){r=i;d=100;h=i-a}else if(r<0){r=0;d=0;h=a}const u=`${l(a)} →<br/>${l(r)} (${d}%)`;const m=`\n                                <div class='touch-row'>\n                                    <div class='touch-row-item'>\n                                        <span class='touch-speed'>${t}速</span>\n                                    </div>\n                                    <div class='touch-row-item-wide'>\n                                        <span class='touch-info'>进度: ${o>0?"+":"-"}${n(h)}</span>\n                                    </div>\n                                </div>\n                                <div class='touch-row'>\n                                    <div class='videoshot-wrapper touch-row-item'>\n                                        <div class='videoshot'></div>\n                                    </div>\n                                    <div class='touch-row-item-wide'>\n                                        <span class='touch-result'>${u}</span>\n                                    </div>\n                                </div>\n                                `;c.innerHTML=m;p.getVideoshot(r,t=>$(".videoshot").css(t));$(".videoshot-wrapper").css("display","flex");$(".touch-progress").css("transform",`scaleX(${d/100})`)}};o.action.lowSpeedBackward=m("低");o.action.lowSpeedForward=m("低");o.action.mediumSpeedBackward=m("中");o.action.mediumSpeedForward=m("中");o.action.highSpeedBackward=m("高");o.action.highSpeedForward=m("高");const v=t=>{return e=>{let i=h+e;let o=Math.abs(e);if(i>100){i=100;o=100-h}else if(i<0){i=0;o=h}const s=`${h} → ${i}`;u(i);const n=`\n                                <div class='touch-row'>\n                                    <div class='touch-row-item'>\n                                        <span class='touch-speed'>${t}速</span>\n                                    </div>\n                                    <div class='touch-row-item-wide'>\n                                        <span class='touch-info'>音量: ${e>0?"+":"-"}${o}</span>\n                                    </div>\n                                </div>\n                                <div class='touch-row'>\n                                    <div class='touch-row-item'>\n                                        <span class='touch-result'>${s}</span>\n                                    </div>\n                                </div>\n                                `;c.innerHTML=n;$(".touch-progress").css("transform",`scaleX(${i/100})`)}};o.action.lowVolumeUp=v("低");o.action.lowVolumeDown=v("低");o.action.mediumVolumeUp=v("中");o.action.mediumVolumeDown=v("中");o.action.highVolumeUp=v("高");o.action.highVolumeDown=v("高");o.action.speedCancel=(()=>{c.innerHTML=`松开手指,取消进退`;$(".touch-progress").css("transform","scaleX(0)")});o.action.volumeCancel=(()=>{c.innerHTML=`松开手指,取消调整`;$(".touch-progress").css("transform","scaleX(0)");u(h)});o.action.onActionEnd=(t=>{d.style.display="none";c.innerHTML="";if(t){if(t.type==="playback"){let o=e.prop("currentTime");o+=t.seconds;if(o<0){o=0}else if(o>i){o=i}e.prop("currentTime",o)}}});console.log("swpier action loaded.")})}}).start();e.applyStyle("touchPlayerStyle","bilibili-touch-video-player");console.log("style loaded.")}})();