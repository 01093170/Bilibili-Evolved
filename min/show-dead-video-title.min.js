(()=>{return(e,t)=>{(async()=>{if(!document.URL.startsWith("https://space.bilibili.com")){return}class t{}class i extends t{convertToDeadVideoInfo(e){return{title:e.title,cover:e.pic}}async queryInfo(e){const t=[];if(e.length<=i.MaxCountPerRequest){const s=await Ajax.getJson(`${i.BiliplusHost}/api/aidinfo?aid=${e.join(",")}`);if(s.code===0){t.push(...e.map(e=>{if(e in s.data){return this.convertToDeadVideoInfo(s.data[e])}else{return{title:"已失效视频",cover:""}}}))}else{console.error(`[显示失效视频信息] Biliplus API 未成功. message=${s.message}`)}}else{t.push(...await this.queryInfo(e.slice(0,i.MaxCountPerRequest)));t.push(...await this.queryInfo(e.slice(i.MaxCountPerRequest)))}return t}}i.BiliplusHost=`https://hd.biliplus.com`;i.MaxCountPerRequest=30;class s extends t{async queryInfo(e){const t=[];await Promise.all(e.map(e=>Ajax.postTextWithCredentials("https://api.bilibili.com/x/v2/history/toview/add",`aid=${e}&csrf=${s.csrf}`)));const i=await Ajax.getJsonWithCredentials("https://api.bilibili.com/x/v2/history/toview/web");if(i.code===0){const a=i.data.list.map(e=>{return{aid:e.aid,title:e.title,cover:e.pic}});t.push(...e.map(e=>a.find(t=>t.aid===parseInt(e))).filter(e=>e!==undefined));await Promise.all(e.map(e=>Ajax.postTextWithCredentials("https://api.bilibili.com/x/v2/history/toview/del",`aid=${e}&csrf=${s.csrf}`)))}else{console.error(`[显示失效视频信息] 稍后再看 API 未成功. message=${i.message}`)}return t}}s.csrf=document.cookie.replace(/(?:(?:^|.*;\s*)bili_jct\s*\=\s*([^;]*).*$)|^.*$/,"$1");const a=await SpinQuery.select("#app>.s-space");if(!a){return}Observer.childListSubtree(a,async()=>{const t=dqa(".disabled[data-aid]");if(t.length===0){return}const i=t.map(e=>e.getAttribute("data-aid"));const a=new s;const r=await a.queryInfo(i);t.forEach((t,i)=>{t.classList.remove("disabled");const s=t.getAttribute("data-aid");const a=(()=>{if(e.useBiliplusRedirect){return`https://hd.biliplus.com/video/av${s}`}else{return`//www.bilibili.com/video/av${s}`}})();const o=t.querySelector("a.cover");o.target="_blank";o.href=a;const n=r[i];if(n.cover!==""){o.querySelector("img").src=n.cover.replace("http:","https:")}const l=t.querySelector("a.title");l.target="_blank";l.title=n.title;l.href=a;l.innerText=n.title})})})()}})();