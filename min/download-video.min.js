(()=>{return(t,e)=>{const i=(unsafeWindow||window).aid;const a=(unsafeWindow||window).cid;if(i===undefined||a===undefined){console.error(`unable to get aid or cid. aid=${i}, cid=${a}`)}class o{constructor(t,e,i){this.quality=t;this.internalName=e;this.displayName=i}static get availableFormats(){return new Promise((t,e)=>{const s=`https://api.bilibili.com/x/player/playurl?avid=${i}&cid=${a}&otype=json`;downloadText(s,e=>{const i=JSON.parse(e).data;const a=i.accept_quality;const s=i.accept_format.split(",");const n=i.accept_description;const l=[];while(a.length>0){const t=new o(a.pop(),s.pop(),n.pop());l.push(t)}t(l)},t=>e(`获取清晰度信息失败: ${t}`))})}}class s{constructor(t,e,i,a){this.length=t;this.size=e;this.url=i;this.backupUrls=a}}class n{constructor(t,e){this.format=t;this.fragments=e||[]}fetchVideoInfo(){return new Promise((t,e)=>{const o=`https://api.bilibili.com/x/player/playurl?avid=${i}&cid=${a}&qn=${this.format.quality}&otype=json`;downloadText(o,i=>{const a=JSON.parse(i).data;if(a.quality!==this.format.quality){e("获取下载链接失败, 请确认当前账号有下载权限后重试.")}const o=a.durl;this.fragments=o.map(t=>new s(t.length,t.size,t.url,t.backup_url));if(this.fragments.length>1){e("暂不支持分段视频的下载.")}t()})})}}return{settingsWidget:{after:()=>$("span.settings-category").filter((t,e)=>e.innerHTML==="视频与直播").parent(),content:e.data.downloadVideoDom.text,success:()=>{o.availableFormats.then(t=>{t.forEach(t=>{$("ol.video-quality").append(`<li>${t.displayName}</li>`)});e.applyStyle("downloadVideoStyle");$("#download-video").on("click",()=>{$(".download-video-panel").toggleClass("opened")}).parent().removeClass("hidden")})}}}}})();