(()=>{return(t,e)=>{class n{constructor(t,e,n,s,o){this.content=t;this.time=e;this.type=n;this.fontSize=s;this.color=o}}class s extends n{constructor({content:t,time:e,type:n,fontSize:s,color:o,timeStamp:i,pool:a,userHash:r,rowId:l}){super(t,e,n,s,o);this.timeStamp=i;this.pool=a;this.userHash=r;this.rowId=l;this.pDataArray=[e,n,s,o,i,a,r,l]}text(){const t=this.pDataArray.join(",");return`<d p="${t}">${this.content}</d>`}static parse(t){const e=t.getAttribute("p");const[n,o,i,a,r,l,c,h]=e.split(",");const u=t.innerHTML;return new s({content:u,time:n,type:o,fontSize:i,color:a,timeStamp:r,pool:l,userHash:c,rowId:h})}}class o{constructor(t){this.xml=t;const e=(new DOMParser).parseFromString(t,"application/xml").documentElement;this.danmakus=[...e.querySelectorAll("d[p]")].map(t=>s.parse(t))}}class i extends n{constructor({content:t,time:e,type:n,fontSize:s,color:o,typeTag:i,colorTag:a,endTime:r}){super(t,e,n,s,o);this.typeTag=i;this.colorTag=a;this.endTime=r}text(t){const e=t[this.fontSize].match(/Style:(.*?),/)[1].trim();return`Dialogue: 0,${this.time},${this.endTime},${e},,0,0,0,,{${this.typeTag}${this.colorTag}}${this.content}`}}class a{constructor({danmakus:t,title:e,fontStyles:n,blockTypes:s,resolution:o}){this.danmakus=t;this.title=e;this.fontStyles=n;this.blockTypes=s;this.resolution=o}generateAss(){const t=`\n[Script Info]\n; Script generated by Bilibili Evolved Danmaku Converter\n; https://github.com/the1812/Bilibili-Evolved/\nTitle: ${this.title}\nScriptType: v4.00+\nPlayResX: ${this.resolution.x}\nPlayResY: ${this.resolution.y}\nTimer: 10.0000\nWrapStyle: 2\nScaledBorderAndShadow: no\n\n[V4+ Styles]\nFormat: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding\n${Object.values(this.fontStyles).join("\n")}\n\n[Events]\nFormat: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text\n                `.trim();return t+"\n"+this.danmakus.map(t=>t.text(this.fontStyles,this.blockTypes)).filter(t=>t!=="").join("\n")}}class r{constructor(t,e,n){this.horizontal=[];this.vertical=[];this.resolution=e;this.duration=n*1e3;this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d");this.fontSizes={25:`36pt ${t}`,18:`26pt ${t}`};this.danmakuType={1:"normal",2:"normal",3:"normal",4:"bottom",5:"top",6:"reversed",7:"special",8:"special"}}getHorizonalTags(t){this.context.font=this.fontSizes[t.fontSize];const e=this.context.measureText(t.content);const n=e.width/2;const s=(e.emHeightAscent+e.emHeightDescent)/2;return`\\move(${1920+n}, ${10+s}, ${-n}, ${10+s}, 0, ${this.duration})`}getVerticalTags(t){if(this.danmakuType[t.type]==="top"){return`\\pos(960, 20)`}else{return`\\pos(960, 1060)`}}push(t){let e=null;let n=null;switch(this.danmakuType[t.type]){case"normal":case"reversed":{e=this.getHorizonalTags(t);n=this.horizontal;break}case"top":case"bottom":{e=this.getVerticalTags(t);n=this.vertical;break}case"special":default:{throw new Error("Danmaku type not supported")}}const s={tags:e};n.push(s);return s}}class l{constructor({title:t,font:e,alpha:n,duration:s,blockTypes:o,resolution:i}){this.title=t;this.font=e;this.alpha=Math.round(n*100);this.duration=s;this.blockTypes=o;this.resolution=i;this.danmakuStack=new r(e,i)}get fontStyles(){return{25:`Style: Medium,${this.font},52,&H${this.alpha}FFFFFF,&H${this.alpha}FFFFFF,&H${this.alpha}000000,&H${this.alpha}000000,0,0,0,0,100,100,0,0,1,1,0,5,0,0,0,0`,18:`Style: Small,${this.font},36,&H${this.alpha}FFFFFF,&H${this.alpha}FFFFFF,&H${this.alpha}000000,&H${this.alpha}000000,0,0,0,0,100,100,0,0,1,1,0,5,0,0,0,0`}}convertToAssDocument(t){const e=[];for(const n of t.danmakus){if(this.blockTypes.concat(7,8).indexOf(n.type)!==-1){continue}const[t,s]=this.convertTime(parseFloat(n.time),this.duration);e.push(new i({content:n.content,time:t,endTime:s,type:n.type,fontSize:n.fontSize,color:n.color,typeTag:this.convertType(n),colorTag:this.convertColor(parseInt(n.color))}))}return new a({danmakus:e,title:this.title,blockTypes:this.blockTypes,fontStyles:this.fontStyles,resolution:this.resolution})}convertType(t){return this.danmakuStack.push(t).tags}convertColor(t){const e=16777215;if(t===e){return""}const n=t.toString(16);const s=n.substring(4,6);const o=n.substring(2,4);const i=n.substring(0,2);return`\\c&H${i}${o}${s}&`}convertTime(t,e){function n(t){return Math.round(t*100)/100}function s(t){let e=0;let s=0;while(t>=60){t-=60;s++}while(s>=60){s-=60;e++}return`${e}:${s.toString().padStart(2,"0")}:${n(t).toString().padStart(4,"0")}`}return[s(t),s(t+e)]}}return{export:{AssDanmaku:i,AssDanmakuDocument:a,Danmaku:n,DanmakuConverter:l,DanmakuStack:r,XmlDanmaku:s,XmlDanmakuDocument:o}}}})();