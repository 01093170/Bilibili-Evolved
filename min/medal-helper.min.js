(()=>{return(e,a)=>{class i{constructor(e){this.isActive=e}static parseJson(e,{successAction:a,errorMessage:i,errorAction:t}){const s=JSON.parse(e);if(s.code!==0){logError(`${i} 错误码:${s.code} ${s.message||""}`);return t(s)}return a(s)}}class t extends i{constructor({medal_id:e,status:a,level:i,medalName:t,uname:s}){super(a===1);this.id=e;this.level=i;this.name=t;this.upName=s}static async getList(){return i.parseJson(await Ajax.getTextWithCredentials("https://api.live.bilibili.com/i/api/medal?page=1&pageSize=256"),{successAction:e=>e.data.fansMedalList.map(e=>new t(e)),errorAction:()=>[],errorMessage:"无法获取勋章列表."})}async activate(){return i.parseJson(await Ajax.getTextWithCredentials(`https://api.live.bilibili.com/i/ajaxWearFansMedal?medal_id=${this.id}`),{successAction:()=>true,errorAction:()=>false,errorMessage:"佩戴勋章失败."})}async deactivate(){return i.parseJson(await Ajax.getTextWithCredentials(`https://api.live.bilibili.com/i/ajaxCancelWear`),{successAction:()=>true,errorAction:()=>false,errorMessage:"卸下勋章失败."})}}class s extends i{constructor({id:e,cid:a,wear:i,css:t,name:r,source:n}){super(i);this.id=e;this.cid=a;this.imageId=t;this.name=r;this.source=n;s.getImageMap().then(e=>{this.imageUrl=e[this.imageId]})}static async getImageMap(){if(s.imageMap===undefined){return i.parseJson(await Ajax.getTextWithCredentials("https://api.live.bilibili.com/rc/v1/Title/webTitles"),{successAction(e){s.imageMap={};e.data.forEach(e=>{s.imageMap[e.identification]=e.web_pic_url});return s.imageMap},errorAction:()=>{return{}},errorMessage:"获取头衔图片失败."})}else{return s.imageMap}}static async getList(){return i.parseJson(await Ajax.getTextWithCredentials("https://api.live.bilibili.com/i/api/ajaxTitleInfo?page=1&pageSize=256&had=1"),{successAction:e=>e.data.list.map(e=>new s(e)),errorAction:()=>[],errorMessage:"无法获取头衔列表."})}async activate(){return i.parseJson(await Ajax.postTextWithCredentials(`https://api.live.bilibili.com/i/ajaxWearTitle`,`id=${this.id}&cid=${this.cid}`),{successAction:()=>true,errorAction:()=>false,errorMessage:"佩戴头衔失败."})}async deactivate(){return i.parseJson(await Ajax.postTextWithCredentials(`https://api.live.bilibili.com/i/ajaxCancelWearTitle`,""),{successAction:()=>true,errorAction:()=>false,errorMessage:"卸下头衔失败."})}}async function r(){const e=$("#medal-helper .popup ul");const a=await t.getList();const i=()=>{a.forEach(a=>{e.find(`li[data-id=${a.id}] input`).prop("checked",a.isActive)})};a.forEach(a=>{const t=$(`<li data-id=${a.id}>\n                <label>\n                    <input name="medal" type="radio" ${a.isActive?"checked":""}>\n                    <div class="fans-medal-item level-${a.level}">\n                        <span class="label">${a.name}</span>\n                        <span class="level">${a.level}</span>\n                    </div>\n                    <span>${a.upName}</span>\n                    <i class="icon-ok"></i>\n                </label>\n                </li>`);e.append(t);t.on("click",()=>{if(a===activatedMedal){a.deactivate().then(i)}else{a.activate().then(i)}})})}return{export:{Badge:i,Medal:t,Title:s},widget:{condition:()=>document.domain==="live.bilibili.com",content:a.data.medalHelperDom.text,success:()=>{$(".medal-helper").each((e,a)=>{const i=$(a);const t=i.find(".popup");i.on("click",()=>t.toggleClass("opened"))});r()}}}}})();