(()=>{return(e,i)=>{class t{constructor(e){this.isActive=e}static parseJson(e,{successAction:i,errorMessage:t,errorAction:a}){const s=JSON.parse(e);if(s.code!==0){logError(`${t} 错误码:${s.code} ${s.message||""}`);return a(s)}return i(s)}}class a extends t{constructor({medal_id:e,status:i,level:t,medalName:a,uname:s}){super(i===1);this.id=e;this.level=t;this.name=a;this.upName=s}static async getList(){return t.parseJson(await Ajax.getTextWithCredentials("https://api.live.bilibili.com/i/api/medal?page=1&pageSize=256"),{successAction:e=>e.data.fansMedalList.map(e=>new a(e)),errorAction:()=>[],errorMessage:"无法获取勋章列表."})}async activate(){return t.parseJson(await Ajax.getTextWithCredentials(`https://api.live.bilibili.com/i/ajaxWearFansMedal?medal_id=${this.id}`),{successAction:()=>{this.isActive=true;return true},errorAction:()=>false,errorMessage:"佩戴勋章失败."})}async deactivate(){return t.parseJson(await Ajax.getTextWithCredentials(`https://api.live.bilibili.com/i/ajaxCancelWear`),{successAction:()=>{this.isActive=false;return true},errorAction:()=>false,errorMessage:"卸下勋章失败."})}}class s extends t{constructor({id:e,cid:i,wear:t,css:a,name:r,source:c}){super(t);this.id=e;this.cid=i;this.imageId=a;this.name=r;this.source=c;s.getImageMap().then(e=>{this.imageUrl=e[this.imageId]})}static async getImageMap(){if(s.imageMap===undefined){return t.parseJson(await Ajax.getTextWithCredentials("https://api.live.bilibili.com/rc/v1/Title/webTitles"),{successAction(e){s.imageMap={};e.data.forEach(e=>{s.imageMap[e.identification]=e.web_pic_url});return s.imageMap},errorAction:()=>{return{}},errorMessage:"获取头衔图片失败."})}else{return s.imageMap}}static async getList(){return t.parseJson(await Ajax.getTextWithCredentials("https://api.live.bilibili.com/i/api/ajaxTitleInfo?page=1&pageSize=256&had=1"),{successAction:e=>e.data.list.map(e=>new s(e)),errorAction:()=>[],errorMessage:"无法获取头衔列表."})}async activate(){return t.parseJson(await Ajax.postTextWithCredentials(`https://api.live.bilibili.com/i/ajaxWearTitle`,`id=${this.id}&cid=${this.cid}`),{successAction:()=>{this.isActive=true;return true},errorAction:()=>false,errorMessage:"佩戴头衔失败."})}async deactivate(){return t.parseJson(await Ajax.postTextWithCredentials(`https://api.live.bilibili.com/i/ajaxCancelWearTitle`,""),{successAction:()=>{this.isActive=false;return true},errorAction:()=>false,errorMessage:"卸下头衔失败."})}}async function r(){const e=$("#medal-helper .popup ul");const i=await a.getList();const t=async()=>{const i=await a.getList();i.forEach(i=>{const t=e.find(`li[data-id=${i.id}]`);if(i.isActive){t.addClass("active")}else{t.removeClass("active")}t.find(`input`).prop("checked",i.isActive)})};i.forEach(i=>{const a=$(`<li data-id=${i.id}>\n                <label title=${i.upName}>\n                    <input name="medal" type="radio" ${i.isActive?"checked":""}>\n                    <div class="fans-medal-item level-${i.level}">\n                        <span class="label">${i.name}</span>\n                        <span class="level">${i.level}</span>\n                    </div>\n                </label>\n                </li>`);e.append(a);a.on("click",e=>{if(i.isActive){i.deactivate().then(t)}else{i.activate().then(t)}e.stopPropagation()})})}return{export:{Badge:t,Medal:a,Title:s},widget:{condition:()=>document.domain==="live.bilibili.com",content:i.data.medalHelperDom.text,success:()=>{$(".medal-helper").each((e,i)=>{const t=$(i);const a=t.find(".popup")[0];t.on("click",e=>{if(!a.contains(e.target)){a.classList.toggle("opened")}})});r()}}}}})();