(()=>{return(n,t)=>{const e=t.attributes.videoInfo.export.DanmakuInfo;async function o(n){const t=document.title.replace("_哔哩哔哩 (゜-゜)つロ 干杯~-bilibili","");const o=new e((unsafeWindow||window).cid);await o.fetchInfo();const a=new Blob([o.rawXML],{type:"text/plain"});const i=URL.createObjectURL(a);const d=$("#danmaku-link");const c=d.attr("href");if(c){URL.revokeObjectURL(c)}clearTimeout(n);document.querySelector("#download-danmaku>span").innerHTML="下载弹幕";d.attr("download",`${t}.xml`).attr("href",i).get(0).click()}return{widget:{content:`\n                    <button\n                        class="gui-settings-flat-button"\n                        id="download-danmaku">\n                        <i class="icon-danmaku"></i>\n                        <span>下载弹幕</span>\n                        <a id="danmaku-link" style="display:none"></a>\n                    </button>`,condition:async()=>{let n=(unsafeWindow||window).aid;let t=(unsafeWindow||window).cid;if(n===undefined||t===undefined){const e=document.URL.match(/\/av(\d+)/);if(e&&e[1]){const o=await new VideoInfo(e[1]).fetchInfo();n=o.aid;t=o.cid}}return t!==undefined},success:()=>{const n=document.querySelector("#danmaku-link");$("#download-danmaku").on("click",t=>{if(t.target!==n){const n=setTimeout(()=>document.querySelector("#download-danmaku>span").innerHTML="请稍侯...",200);o(n)}})}}}}})();